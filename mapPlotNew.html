<!DOCTYPE html>
<html style="height: 100%">
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href='css/style.css'>
</head>

<body style="height: 100%">
<div class='label'>
    <input type="file" id='hospitalFile' class='inputfile'/> 
    <label for="hospitalFile"><span></span><strong>医院数据</strong></lable>    
</div>
<div class='label'>
    <input type="file" id='deptFile' class='inputfile'/> 
    <label for="deptFile"><span></span><strong>科室数据</strong></lable>    
</div>
<div id="tabs1">
    <ul>
        <li><a href="#" class='hospital'><span>按医院分布</span></a></li>
        <li><a href="#" class='dept'><span>按科室分布</span></a></li>
        <li><a href="chartPlot.html"><span>图表模式</span></a></li>
    </ul>
</div>
<div style="clear:both;"></div>
<div id="container" style="height: 100%"></div>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/echarts.min.js"></script>
<script type="text/javascript" src="js/papaparse.min.js"></script>
<script type="text/javascript" src="js/geoCoordMap.js"></script>
<script type="text/javascript" src="js/china.js"></script>
<script type="text/javascript" src="js/custom-file-input.js"></script>
<script type="text/javascript">
var dom = document.getElementById("container");
var myChart = echarts.init(dom);
var app = {};
option = null;

function  handleFiles(files)  
{  
    var file = files[0];  
    if (!file) {
        alert("未选择相关数据文件！");
        return;
    }
    Papa.parse(file, {
        header: true,
        encoding: 'gbk',
        complete: function(rst) {
            option = setOption(rst);
            myChart.setOption(option, true);
            deptList = rst.data.map(csvToDataList);    
        } 
    });
} 

function csvToDataList(x) {
    var idx = x[""];
    delete x[""];
    rst = Object.keys(x).map(function(key){
        
            return {"name":key,"value":x[key]};
    } );
    return [idx,rst];
}

var convertData = function (data) {
    var res = [];
    for (var i = 0; i < data.length; i++) {
        var geoCoord = geoCoordMap[data[i].name];
        if(!geoCoord){geoCoord=[0,0]}
            res.push({
                name: data[i].name,
                value: geoCoord.concat([data[i].value, Math.log(data[i].value)/Math.log(1.1)])
            });
    }
    return res;
};

// var provinceList = ['上海', '浙江', '广东', '江苏', '安徽', '山东', '新疆', '北京', '河南', '福建', '贵州', '江西', '天津', '湖北', '辽宁', '湖南', '黑龙江', '甘肃', '吉林', '云南', '内蒙古', '宁夏', '陕西', '山西', '青海', '四川', '广西', '河北', '重庆', '海南', '西藏','台湾','香港','澳门']

// var convertDataProvince = function(data) {
//     var res = [];
//     var map = {};
//     for (var i = 0; i < provinceList.length; i++) {map[provinceList[i]] = 0;}
//     for (var i = 0; i < data.length; i++) {
//         map[data[i].name] = data[i].value;
//     }
//     for (var key in map) {
//         var value = map[key];
//         var logValue = (value!=0)? Math.log(value)/Math.log(1.1) : 0;
//         var geoCoord = geoCoordMap[key];
//         if(!geoCoord){geoCoord=[0,0]}
//             res.push({
//                 name: key,
//                 value: geoCoord.concat([value, logValue])
//             });
//     }
//     return res;
// }
// var color = ['#46bee9','#a6c84c', 
// '#ffa022', '#d3d30c','#46bee9','#5e71ff','#07af58','#a6c84c', '#ffa022', '#d3d30c','#46bee9','#5e71ff',
// '#ffa022', '#d3d30c','#46bee9','#5e71ff','#07af58','#a6c84c', '#ffa022', '#d3d30c','#46bee9','#5e71ff'];

// deptList = ['妇科','皮肤科','中医内科','耳鼻喉科','眼科','骨科','神经内科','肿瘤科','消化科','内分泌科'];
// hospitalList = ['复旦大学附属华山医院（总院托管）','复旦大学附属肿瘤医院','上海交通大学医学院附属第九人民医院','复旦大学附属眼耳鼻喉科医院','上海中医药大学附属岳阳中西医结合医院','复旦大学附属妇产科医院（黄浦）','儿科医院(医联)','复旦大学附属妇产科医院（杨浦）','瑞金医院(医联)','岳阳医院青海路特诊部'];


function prepareOptions(dataList) {
    options = [];
    dataList.forEach(function (item, i) {
        options.push(
        {
            title: {subtext: item[0]},
            series: [
            {
                name: item[0],
                data: convertData(item[1])
            },
            {
                name: item[0],
                data: convertData(item[1])
            }]
        });
    });
    return options;
}
function setOption(rst) {
    dataList = rst.data.slice(0,10).map(csvToDataList);
    nameList = dataList.map(function(x){return x[0];});
    provinceList = rst.meta.fields.slice(1); //first grid in the matrix is empty
    option = {
        baseOption: {
            timeline: {
                autoPlay: false,
                playInterval: 1000,
                axisType: 'category',
                data: nameList,
                lineStyle : {
                    color: '#fff'
                },
                label: {
                    normal : {
                        textStyle: {
                            color: '#fff'
                        }
                    }
                },
                itemStyle: {
                    normal : {
                        color: '#fff'
                    }
                },
                checkpointStyle: {
                    normal : {
                        color: '#fff'
                    }
                },
                controlStyle: {
                    normal : {
                        color: '#fff'
                    }
                }
            },
            backgroundColor: '#404a59',
            title : {
                text: '就医人群地区分布',
                subtext: '根据患者手机号获取地区',
                left: 'center',
                textStyle : {
                    color: '#fff'
                }
            },
            tooltip : {
                trigger: 'item',
                formatter: function (params,ticket,callback) {
                    if(params.name == "") {return;}
                    var res = params.name +'<br/>';
                    var value = 0;
                    if (params.data.value) {value = String(params.data.value[2]);}
                    
                    res += '排名: ' + (params.dataIndex + 1);
                    res += '\t人数: ' + value;
                    setTimeout(function (){callback(ticket, res);}, 1);
                    return 'loading';
                }
            },
            geo: {
                map: 'china',
                show: false,
                // zlevel: 1,
                label: {
                    emphasis: {
                        show: false
                    }
                },
                // roam: true,
                itemStyle: {
                    normal: {
                        areaColor: '#323c48',
                        borderColor: '#404a59'
                    },
                    emphasis: {
                        areaColor: '#2a333d'
                    }
                }
            },
            visualMap: {
                min: 0,
                max: 100,
                left: 'right',
                top: 'top',
                dimension:3,
                seriesIndex: 0,    
                calculable: true,
                formatter: function (value, value2) {
                    return Math.round(Math.exp(value * Math.log(1.1)));
                },
                target:{
                    inRange: {
                        color: ['#50a3ba','#eac736','#d94e5d']
                    },
                    outOfRange: {
                        color: ['#444']
                    }
                },
                controller: {
                    inRange: {
                        color: ['#50a3ba','#eac736','#d94e5d']
                    },
                    outOfRange: {
                        color: ['#444']
                    }            
                }
            },
            series:    [
            {
                type: 'map',
                mapType: 'china',
                // roam: true,
                label: {
                    normal: {
                        show: true
                    },
                    emphasis: {
                        show: true
                    }
                },
                // selectedMode:'single',
                itemStyle: {
                    normal: {
                        opacity:0.8
                    },
                    emphasis: {
                        shadowBlur: 20,
                        shadowColor: '#fff'
                    }
                },
            },
            {
                type: 'effectScatter',
                coordinateSystem: 'geo',
                // zlevel: 1,
                rippleEffect: {
                    brushType: 'stroke'
                },
                label: {
                    emphasis: {
                        show: false
                    }
                },
                symbolSize: function (val) {
                    return Math.max(Math.log(val[2])/Math.log(3),1);
                },
                itemStyle: {
                    normal: {
                        // color: color[i],
                        opacity:0.5
                    },
                    emphasis: {
                        opacity: 1
                    }

                }
            }]
        },
        options: prepareOptions(dataList)
    };
    return option;
}

// if (option && typeof option === "object") {
//     var startTime = +new Date();
//     myChart.setOption(option, true);
//     var endTime = +new Date();
//     var updateTime = endTime - startTime;
//     console.log("Time used:", updateTime);
// }

$('.hospital').on('click', function () {
    file = ($('#hospitalFile'))[0].files;
    handleFiles(file);
});
$('#hospitalFile.inputfile').change(function () {
    file = ($('#hospitalFile'))[0].files;
    handleFiles(file);
});
$('.dept').on('click', function () {
    file = ($('#deptFile'))[0].files;
    handleFiles(file);
});
$('#deptFile.inputfile').on('click', function () {
    file = ($('#deptFile'))[0].files;
    handleFiles(file);
});

    </script>
</body>
</html>