<!DOCTYPE html>
<html style="height: 100%">
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href='css/style.css'>
</head>

<body style="height: 100%">
<div class='label'>
    <input type="file" id='hospitalFile' class='inputfile'/> 
    <label for="hospitalFile"><span></span><strong>医院数据</strong></lable>    
</div>
<div class='label'>
    <input type="file" id='deptFile' class='inputfile'/> 
    <label for="deptFile"><span></span><strong>科室数据</strong></lable>    
</div>
<div id="tabs1">
    <ul>
        <li><a href="#" class='hospital'><span>按医院分布</span></a></li>
        <li><a href="#" class='dept'><span>按科室分布</span></a></li>
        <li><a href="mapPlot.html"><span>地图模式</span></a></li>
    </ul>
</div>
<div style="clear:both;"></div>
<div id="container" style="height: 100%"></div>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/echarts.min.js"></script>
<script type="text/javascript" src="js/papaparse.min.js"></script>

<script type="text/javascript" src="js/custom-file-input.js"></script>
<script type="text/javascript">
var dom = document.getElementById("container");
var myChart = echarts.init(dom);
var app = {};


function  handleFiles(files)  
{  
    var file = files[0];  
    if (!file) {
        alert("未选择相关数据文件！");
        return;
    }
    Papa.parse(file, {
        header: true,
        encoding: 'gbk',
        complete: function(rst) {
            option = setOption(rst);
            myChart.setOption(option, true);
            deptList = rst.data.map(csvToDataList);    
        } 
    });
}  

function csvToDataList(x) {
    var idx = x[""];
    delete x[""];
    rst = Object.keys(x).map(function(key){
        
            return {"name":key,"value":x[key]};
    } );
    return [idx,rst];
}

function prepareOptions(dataList) {
    options = [];
    dataList.forEach(function (item, i) {
        var sum = item[1].reduce( function(a,b) {
            return a + parseInt(b.value);
        }, 0);
        options.push(
            {
                title: {text: item[0]},
                series: [
                    {data: item[1]},
                    {
                        data: item[1].map( function(x) { return (1.0 * x.value/sum).toFixed(4);}),
                        yAxisIndex: 1
                    },
                    {data: item[1]}
                ]
            }
            )
    });
    return options;  
}


function setOption(rst) {
    dataList = rst.data.slice(0,10).map(csvToDataList);
    nameList = dataList.map(function(x){return x[0];});
    provinceList = rst.meta.fields.slice(1); //first grid in the matrix is empty
    option = {
        baseOption: {
            timeline: {
                axisType: 'category',
                autoPlay: false,
                playInterval: 1000,
                data: nameList
            },
            title: {
                subtext: '外地人口就医分布'
            },
            toolbox: {
                feature: {
                    dataView: {show: true, readOnly: false},
                    magicType: {show: true, type: ['line', 'bar']},
                    restore: {show: true},
                    saveAsImage: {show: true}
                }
            },
            tooltip : {
                trigger: 'item' // or 'axis'
                // formatter: "{a} <br/>{b} : {c} ({d}%)"
            },
            legend: {
                x: 'center',
                data: ['人数','百分比','饼图'],
                selected: {
                    '百分比': false,
                    '饼图': false
                }
            },
            calculable : true,
            grid: {
                top: 80,
                bottom: 100
            },
            xAxis: [
                {
                    'type':'category',
                    'axisLabel':{'interval':0},
                    'data': provinceList,
                    splitLine: {show: false}
                }
            ],
            yAxis: [
                {
                    type: 'value',
                    name: '人数',
                },
                {
                    type: 'value',
                    name: '百分比',
                    // max: 0.2,
                    // min: -0.2
                }           
            ],
            series: [
                {
                    name: '人数', 
                    type: 'bar',
                    label: {
                        normal: {
                            show: true,
                            position: 'top'
                        },
                        emphasis: {
                            show: true
                        }
                    }
                },
                {
                    name: '百分比',
                    type: 'line',
                    label: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true,
                            position: 'top',
                            formatter: function (params) {
                                value = (params.value * 100).toFixed(2);
                                return String(value) + '%';
                            }
                        }
                    }
                },
                {
                    name: '饼图', 
                    type: 'pie', 
                    center: ['75%', '35%'],
                    radius: '40%',
                    label: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true
                        }
                    },
                    lableLine: {
                        normal: {
                            show: false
                        },
                        emphasis: {
                            show: true
                        }
                    },
                }
            ]
        },
        options:prepareOptions(dataList)
    };
    return option;
}


// if (option && typeof option === "object") {
//     var startTime = +new Date();
//     myChart.setOption(option, true);
//     var endTime = +new Date();
//     var updateTime = endTime - startTime;
//     console.log("Time used:", updateTime);
// }

$('.hospital').on('click', function () {
    file = ($('#hospitalFile'))[0].files;
    handleFiles(file);
});
$('#hospitalFile.inputfile').change(function () {
    file = ($('#hospitalFile'))[0].files;
    handleFiles(file);
});
$('.dept').on('click', function () {
    file = ($('#deptFile'))[0].files;
    handleFiles(file);
});
$('#deptFile.inputfile').change(function () {
    file = ($('#deptFile'))[0].files;
    handleFiles(file);
});
    </script>
</body>
</html>