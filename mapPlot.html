<!DOCTYPE html>
<html style="height: 100%">
   <head>
       <meta charset="utf-8">
   </head>
   <body style="height: 100%; margin: 0">
       <div id="container" style="height: 100%"></div>
       <script type="text/javascript" src="js/echarts.min.js"></script>
       <script type="text/javascript" src="js/china.js"></script>
       <script type="text/javascript" src="js/geoCoordMap.js"></script>
       <script type="text/javascript" src="js/data.js"></script>
       <script type="text/javascript">
var dom = document.getElementById("container");
var myChart = echarts.init(dom);
var app = {};
option = null;

deptList = ['妇科','皮肤科','中医内科','耳鼻喉科','眼科','骨科','神经内科','肿瘤科','消化科','内分泌科'];
hospitalList = ['复旦大学附属华山医院（总院托管）','复旦大学附属肿瘤医院','上海交通大学医学院附属第九人民医院','复旦大学附属眼耳鼻喉科医院','上海中医药大学附属岳阳中西医结合医院','复旦大学附属妇产科医院（黄浦）','儿科医院(医联)','复旦大学附属妇产科医院（杨浦）','瑞金医院(医联)','岳阳医院青海路特诊部'];


var color = ['#46bee9','#a6c84c', 
'#ffa022', '#d3d30c','#46bee9','#5e71ff','#07af58','#a6c84c', '#ffa022', '#d3d30c','#46bee9','#5e71ff',
'#ffa022', '#d3d30c','#46bee9','#5e71ff','#07af58','#a6c84c', '#ffa022', '#d3d30c','#46bee9','#5e71ff'];

var convertData = function (data) {
    var res = [];
    for (var i = 0; i < data.length; i++) {
        var geoCoord = geoCoordMap[data[i].name];
        if(!geoCoord){geoCoord=[0,0]}
            res.push({
                name: data[i].name,
                value: geoCoord.concat([data[i].value, Math.log(data[i].value)/Math.log(1.1)])
            });
    }
    return res;
};

var provinceList = ['上海', '浙江', '广东', '江苏', '安徽', '山东', '新疆', '北京', '河南', '福建', '贵州', '江西', '天津', '湖北', '辽宁', '湖南', '黑龙江', '甘肃', '吉林', '云南', '内蒙古', '宁夏', '陕西', '山西', '青海', '四川', '广西', '河北', '重庆', '海南', '西藏','台湾','香港','澳门']

var convertDataProvince = function(data) {
    var res = [];
    var map = {};
    for (var i = 0; i < provinceList.length; i++) {map[provinceList[i]] = 0;}
    for (var i = 0; i < data.length; i++) {
        map[data[i].name] = data[i].value;
    }
    for (var key in map) {
        var value = map[key];
        var logValue = (value!=0)? Math.log(value)/Math.log(1.1) : 0;
        var geoCoord = geoCoordMap[key];
        if(!geoCoord){geoCoord=[0,0]}
            res.push({
                name: key,
                value: geoCoord.concat([value, logValue])
            });
    }
    return res;
}


// var convertDataPie = function (data, len) {
//     var res = [];
//     for (var i = 0; i < len; i++) {
//         var geoCoord = geoCoordMap[data[i].name];
//         if (geoCoord) {
//             res.push({
//                 name: data[i].name,
//                 value: geoCoord.concat(data[i].value)
//             });
//         }
//     }
//     var remain = 0;
//     for (var i = len; i < data.length; i++) {
//         remain += data[i].value;
//     }
//     res.push({
//         name: "其他",
//         value: "".concat(remain)
//     });
    
//     return res;
// }

var convertDataLine = function (data) {
    var res = [];
    for (var i = 0; i < data.length; i++) {
        var fromCoord = geoCoordMap[data[i].name];
        var toCoord = [121.29,31.14]; //上海
        if (fromCoord && toCoord) {
            res.push([{
                coord: fromCoord
            }, {
                coord: toCoord
            }]);
        }
    }
    return res;
};


var series = [];
var seriesMap = {};
[['All', dataMapProvince.get('All')]].concat(getSeclectData(deptList,dataMapProvince), getSeclectData(hospitalList, dataMapProvince)).forEach(function (item, i) {
    seriesMap['P_'+item[0]] = convertDataProvince(item[1]);
    series.push(
    {
            name: 'P_' + item[0],
            type: 'map',
            mapType: 'china',
            // roam: true,
            label: {
                normal: {
                    show: true
                },
                emphasis: {
                    show: true
                }
            },
            // selectedMode:'single',
            itemStyle: {
                normal: {
                    color: color[i],
                    opacity:0.8
                },
                emphasis: {
                    shadowBlur: 20,
                    shadowColor: '#fff'
                }
            },
            data: convertDataProvince(item[1])
    }

    // ,{
    //     name: item[0],
    //     type: 'pie',
    //     radius : '25%',
    //     center: ['10%','20%'],
    //     data : convertDataPie(item[1],30),
    //     label: {
    //             normal: {
    //                 show : true,
    //                 color: '#fff'
    //             }
    //     },
    //     itemStyle: {
    //         normal: {
    //             color: color[i]
    //         }
    //     }
    // }
    )
});

[['All', dataMapCity.get('All')]].concat(getSeclectData(deptList,dataMapCity), getSeclectData(hospitalList, dataMapCity)).forEach(function (item, i) {
    series.push(
    {
        name: 'C_' + item[0],
        type: 'effectScatter',
        coordinateSystem: 'geo',
        // zlevel: 1,
        rippleEffect: {
            brushType: 'stroke'
        },
        label: {
            emphasis: {
                show: false
            }
        },
        symbolSize: function (val) {
            return Math.max(Math.log(val[2])/Math.log(3),1);
        },
        itemStyle: {
            normal: {
                color: color[i],
                opacity:0.5
            },
            emphasis: {
                opacity: 1
            }

        },
        data: convertData(item[1])
    }
    ,{
        name:  'C_' + item[0],
        type: 'lines',
        // zlevel: 1,
        // effect: {
        //     show: true,
        //     period: 6,
        //     trailLength: 0
        // },
        lineStyle: {
            normal: {
                color: color[i],
                width: 1,
                opacity: 0.4,
                curveness: 0.2
            }
        },
        data: convertDataLine(item[1].sort(function (a, b) {
                return b.value - a.value;
            }).slice(0, 100)),
    }
    ,{
        name: 'C_' + item[0],
        type: 'scatter',
        coordinateSystem: 'geo',
        // zlevel: 1,
        label: {
            normal: {
                show: true,
                position: 'right',
                formatter: function (params) {
                    var idx = params.dataIndex + 1;
                    var name = params.data.name
                    return  '[' + idx + ']' + name;
                }
            }
        },
        symbolSize: 1,
        itemStyle: {
            normal: {
                color: '#fff',
                opacity:0.8
            }
        },
        data: convertData(item[1].sort(function (a, b) {
                return b.value - a.value;
            }).slice(1, 11)), //skip 上海
    }
    )
});

option = {
    backgroundColor: '#404a59',
    title : {
        text: '就医人群地区分布',
        subtext: '根据患者手机号获取地区',
        left: 'center',
        textStyle : {
            color: '#fff'
        }
    },
    tooltip : {
        trigger: 'item',
        formatter: function (params,ticket,callback) {
            if(params.name == "") {return;}
            var res = params.name +'<br/>';
            var value = 0;
            if (params.data.value) {value = String(params.data.value[2]);}
            
            res += '排名: ' + (params.dataIndex + 1);
            res += '\t人数: ' + value;
            setTimeout(function (){callback(ticket, res);}, 1);
            return 'loading';
        }
    },
    legend: [{
        orient: 'vertical',
        top: 'bottom',
        left: 'right',
        data:["P_All"].concat(deptList.map(function(x){return 'P_'+x;})),
        textStyle: {
            color: '#fff'
        },
        selectedMode: 'single',
        formatter: function (name) {
            return "";
        }
    },
    {
        orient: 'vertical',
        top: 'bottom',
        left: 'left',
        data: ["P_All"].concat(hospitalList.map(function(x){return 'P_'+x;})),
        textStyle: {
            color: '#fff'
        },
        selectedMode: 'single',
        formatter: function (name) {
            return "";
        }
    },
    {
        orient: 'vertical',
        top: 'bottom',
        left: 'right',
        data:["C_All"].concat(deptList.map(function(x){return 'C_'+x;})),
        textStyle: {
            color: '#fff',
            fontSize: 0
        },
        padding: [5,40,5,5],
        selectedMode: 'single',
        formatter: function (name) {
            return name.split('_')[1];
        }
    },
    {
        orient: 'vertical',
        top: 'bottom',
        left: 'left',
        data: ["C_All"].concat(hospitalList.map(function(x){return 'C_'+x;})),
        textStyle: {
            color: '#fff',
            fontSize: 0
        },
        padding: [5,5,5,40],
        selectedMode: 'single',
        formatter: function (name) {
            return name.split('_')[1];
        }
    }
    ],
    geo: {
        map: 'china',
        show: false,
        // zlevel: 1,
        label: {
            emphasis: {
                show: false
            }
        },
        // roam: true,
        itemStyle: {
            normal: {
                areaColor: '#323c48',
                borderColor: '#404a59'
            },
            emphasis: {
                areaColor: '#2a333d'
            }
        }
    },
    visualMap: {
        min: 30,
        max: 100,
        left: 'left',
        top: 'top',
        dimension:3,
        seriesIndex: [0,1,2] ,    
        calculable: true,
        formatter: function (value, value2) {
            return Math.round(Math.exp(value * Math.log(1.1)));
        },
        target:{
            inRange: {
                colorLightness: [1, 0.2]
            },
            outOfRange: {
                color: ['#444']
            }
        },
        controller: {
            inRange: {
                color: ['#50a3ba','#eac736','#d94e5d']
            },
            outOfRange: {
                color: ['#444']
            }            
        }
    },
    series: series
};

if (option && typeof option === "object") {
    var startTime = +new Date();
    myChart.setOption(option, true);
    var endTime = +new Date();
    var updateTime = endTime - startTime;
    console.log("Time used:", updateTime);
    console.log(myChart.getOption());
}


myChart.on('legendselectchanged', function (params) {
    if(params.name in seriesMap) { //Province
        var max = 0;
        series = seriesMap[params.name];
        for(var i=0; i<series.length; i++) {
            if(series[i].name == "上海") { max = series[i].value[3];}
        }
        myChart.setOption({
            visualMap: {
                max: max
            },
            geo: {
                show: false
            }
        },false);
        myChart.dispatchAction({
            type: 'selectDataRange',
            selected: [0,max]
        });
    }
    else { //City
        myChart.setOption({
            geo: {
                show: true,
            }
        },false);
    }
});



myChart.on('click', function (params) {
    myChart.dispatchAction({
        type: 'legendSelect',
        name: params.seriesName
    })
});

       </script>
   </body>
</html>